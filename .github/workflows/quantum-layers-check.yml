name: Quantum Layers Check

on:
  push:
    branches: [ main, develop, "copilot/**" ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  layers:
    name: Guard terminology & domain layers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Guard LLC terminology & layers
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Scanning for forbidden terminology‚Ä¶"
          # Enforce approved terminology: 'Federation Entanglement' and 'Station Envelope'
          if grep -RInE "\bFine[[:space:]]+Element\b|\bStation[[:space:]]+Envelop\b" \
              --include='*.md' --include='*.yaml' --include='*.yml' --include='*.json' \
              --include='*.py' --include='*.qasm' --include='*.xml' --include='*.xsd' \
              --include='*.proto' --include='*.r' --include='*.jl' . ; then
            echo "::error::Forbidden terminology found (use 'Federation Entanglement' and 'Station Envelope')."
            exit 1
          fi
          # Soft check for deprecated 'Federation Element'
          if grep -RInE "\bFederation[[:space:]]+Element\b" \
              --include='*.md' --include='*.yaml' --include='*.yml' --include='*.json' \
              --include='*.py' --include='*.qasm' --include='*.xml' --include='*.xsd' \
              --include='*.proto' --include='*.r' --include='*.jl' . ; then
            echo "::warning::Found deprecated phrase 'Federation Element'. Please migrate to 'Federation Entanglement'."
          fi
          echo "‚úÖ Terminology OK"

          echo "üîç Checking quantum-classical bridge layers across domains‚Ä¶"
          MISSING=0
          if [ -d "2-DOMAINS-LEVELS" ]; then
            for D in 2-DOMAINS-LEVELS/*; do
              [ -d "$D/TFA" ] || continue
              for pair in BITS/CB QUBITS/QB ELEMENTS/UE ELEMENTS/FE WAVES/FWD STATES/QS; do
                if [ ! -e "$D/TFA/$pair" ]; then
                  echo "::error file=$D::Missing $pair"
                  MISSING=1
                fi
              done
            done
          fi
          [ $MISSING -eq 0 ] || exit 1
          echo "‚úÖ Domain layers OK"

  impl_buckets:
    name: Verify code implementation buckets
    runs-on: ubuntu-latest
    needs: layers
    steps:
      - uses: actions/checkout@v4

      - name: Check Python implementation buckets
        shell: bash
        run: |
          set -euo pipefail

          echo "üîç Verifying Python buckets exist‚Ä¶"
          missing=0
          buckets=(
            "5-ARTIFACTS-IMPLEMENTATION/CODE/python/classical-bits"
            "5-ARTIFACTS-IMPLEMENTATION/CODE/python/quantum-qubits"
            "5-ARTIFACTS-IMPLEMENTATION/CODE/python/unit-elements"
            "5-ARTIFACTS-IMPLEMENTATION/CODE/python/federation-elements"
            "5-ARTIFACTS-IMPLEMENTATION/CODE/python/wave-dynamics"
          )
          for b in "${buckets[@]}"; do
            if [ ! -d "$b" ]; then
              echo "::error::Missing implementation bucket: $b"
              missing=1
            fi
          done
          [ $missing -eq 0 ] || exit 1
          echo "‚úÖ Implementation buckets OK"

  qs_schema_validation:
    name: Validate QS manifest schemas
    runs-on: ubuntu-latest
    needs: layers
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema pyyaml

      - name: Validate QS manifests against schema
        shell: bash
        run: |
          set -euo pipefail
          
          echo "üî¨ Validating Quantum State (QS) manifests against schema..."
          
          # Check if AQUA schema files exist
          qs_schema="services/aqua-webhook/schemas/quantum_state.json"
          if [ ! -f "$qs_schema" ]; then
            echo "::warning::QS schema not found: $qs_schema"
            echo "‚úÖ QS schema validation skipped (schema not available)"
            exit 0
          fi
          
          validation_errors=0
          total_files=0
          
          # Find all QS manifest files
          while IFS= read -r -d '' file; do
            # Skip if not in QS directory
            if [[ ! "$file" =~ /TFA/STATES/QS/ ]]; then
              continue
            fi
            
            total_files=$((total_files + 1))
            echo "üìÑ Validating: $file"
            
            # Validate with Python script
            if python3 << EOF
import json
import yaml
import jsonschema
import sys

# Load schema
try:
    with open('$qs_schema', 'r') as f:
        schema = json.load(f)
except Exception as e:
    print(f"Error loading schema: {e}")
    sys.exit(1)

# Load manifest
try:
    with open('$file', 'r') as f:
        if '$file'.endswith(('.yaml', '.yml')):
            manifest = yaml.safe_load(f)
        else:
            manifest = json.load(f)
except Exception as e:
    print(f"Error loading manifest: {e}")
    sys.exit(1)

# Validate
try:
    jsonschema.validate(manifest, schema)
    print("‚úÖ Valid QS manifest")
except jsonschema.ValidationError as e:
    print(f"‚ùå Validation error: {e.message}")
    if e.absolute_path:
        print(f"   Path: {' -> '.join(str(p) for p in e.absolute_path)}")
    sys.exit(1)
except Exception as e:
    print(f"‚ùå Unexpected validation error: {e}")
    sys.exit(1)
EOF
            then
              echo "   ‚úÖ Valid"
            else
              echo "   ‚ùå Invalid"
              validation_errors=$((validation_errors + 1))
            fi
            
          done < <(find 2-DOMAINS-LEVELS -name "*.json" -o -name "*.yaml" -o -name "*.yml" -print0 2>/dev/null || true)
          
          echo ""
          echo "üìä QS Schema Validation Summary:"
          echo "   Total QS files checked: $total_files"
          echo "   Validation errors: $validation_errors"
          
          if [ $validation_errors -gt 0 ]; then
            echo "::error::$validation_errors QS manifest(s) failed schema validation"
            exit 1
          elif [ $total_files -eq 0 ]; then
            echo "::warning::No QS manifests found for validation"
            echo "‚úÖ QS schema validation passed (no files to validate)"
          else
            echo "‚úÖ All QS manifests pass schema validation"
          fi

  aqua_integration_test:
    name: Test AQUA service integration
    runs-on: ubuntu-latest
    needs: [layers, qs_schema_validation]
    if: success() || failure()  # Run even if QS validation fails
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install AQUA dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r services/aqua-webhook/requirements.txt

      - name: Test AQUA manifest validation
        shell: bash
        run: |
          set -euo pipefail
          
          echo "üß™ Testing AQUA manifest validation..."
          
          # Test with sample FE manifest
          python3 << 'EOF'
import sys
import os
sys.path.append('services/aqua-webhook')

from schemas.manifest_schema import validate_manifest
from canonicalize import compute_canonical_hash

# Sample FE manifest
sample_manifest = {
    "type": "FE",
    "name": "Test Federation Entanglement",
    "version": "1.0.0",
    "description": "Test federation for AQUA validation",
    "members": [
        {"domain": "AAA", "role": "coordinator", "weight": 2},
        {"domain": "CQH", "role": "participant", "weight": 1}
    ],
    "orchestration_rules": {
        "consensus_protocol": "proof-of-authority",
        "quorum_threshold": 0.67,
        "timeout_seconds": 300
    }
}

# Test validation
print("üìã Testing FE manifest validation...")
result = validate_manifest(sample_manifest, "TFA/ELEMENTS/FE")

if result['valid']:
    print("‚úÖ FE manifest validation passed")
    canonical_hash = compute_canonical_hash(sample_manifest)
    print(f"üìù Canonical hash: {canonical_hash}")
else:
    print("‚ùå FE manifest validation failed")
    for error in result['errors']:
        print(f"   Error: {error}")
    sys.exit(1)

# Test with sample QS manifest
sample_qs_manifest = {
    "type": "QS",
    "name": "Test Quantum State",
    "version": "1.0.0",
    "description": "Test quantum state for AQUA validation",
    "state_data": {
        "representation_type": "state_vector",
        "dimension": 2,
        "state_vector": [
            {"real": 0.7071, "imag": 0.0},
            {"real": 0.0, "imag": 0.7071}
        ],
        "purity": 1.0,
        "normalization": 1.0
    },
    "measurement_protocols": [
        {
            "name": "Z-measurement",
            "type": "projective",
            "operators": [
                {
                    "name": "Z0",
                    "matrix": [
                        [{"real": 1, "imag": 0}, {"real": 0, "imag": 0}],
                        [{"real": 0, "imag": 0}, {"real": 0, "imag": 0}]
                    ]
                }
            ],
            "basis": "computational",
            "readout_fidelity": 0.95
        }
    ],
    "coherence_metrics": {
        "t1_relaxation_time": 100.0,
        "t2_coherence_time": 80.0,
        "fidelity": 0.99
    }
}

print("\nüî¨ Testing QS manifest validation...")
qs_result = validate_manifest(sample_qs_manifest, "TFA/STATES/QS")

if qs_result['valid']:
    print("‚úÖ QS manifest validation passed")
    qs_canonical_hash = compute_canonical_hash(sample_qs_manifest)
    print(f"üìù QS canonical hash: {qs_canonical_hash}")
else:
    print("‚ùå QS manifest validation failed")
    for error in qs_result['errors']:
        print(f"   Error: {error}")
    sys.exit(1)

print("\nüéâ All AQUA validation tests passed!")
EOF
